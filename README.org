#+TITLE: Kopie bezpieczestwa
#+SUBTITLE: Projektowanie system贸w bezpieczestwa
#+AUTHOR: Patryk Gronkiewicz 164157, Piotr Krawiec 164165
#+EMAIL: 164157@stud.prz.edu.pl, 164165@stud.prz.edu.pl
#+OPTIONS: toc:nil
#+LANGUAGE: pl

* Wybrane programy
** Rsync + tar
Jest to najprostsza opcja dostpna na praktycznie ka偶dym urzdzeniu z Linuxem. Rozwizanie to skada si w rzeczywistoci z dw贸ch program贸w - /rsync/ oraz /tar/. Pierwszy z nich su偶y do kopiowania plik贸w lokalnie oraz na serwery zdalne, natomiast drugi generuje pojedynczy plik z naszego backupu. /tar/ pozwala tak偶e na zmniejszenie rozmiaru kopii dziki wykorzystaniu kompresji.

W naszym przypadku przydatne okazao si te偶 polecenie /date/, kt贸re posu偶yo do nadawania unikalnych nazw kolejnym kopiom zapasowym. Dodatkowo zastosowano /cron-a/, kt贸ry pozwoli nam na zaplanowanie wykonywania kopii.
** Duplicati
W naszym zestawie rozwiza jest to najbardziej multiplatformowe i proste do u偶ycia rozwizanie - jest proste do ustawienia zar贸wno na Windowsie, Linuxie, jak i macOS. Po zainstalowaniu go mo偶emy zarzdza wszystkimi jego ustawieniami z pomoc interfejsu przegldarkowego. Jako jedyne niestety nie ma opcji ustawiania z pomoc linii komend, co mo偶na rozwiza z pomoc zewntrznych pakiet贸w dostpnych np. w /pip/-ie.
** Restic
Rozwizanie najbardziej rozbudowane, lecz wymagajce wicej dowiadczenia w konfiguracji. Pozwala na stosunkowo proste skonfigurowanie retencji, poczenia do mniej typowych chmur takich jak S3, lecz nie uruchamia si automatycznie. Do odpowiedniego dziaania wymagane jest, aby u偶y planowania backup贸w przez CRON lub =systemd-timers=.

Tw贸rcy twierdz, 偶e jest:
+ prosty w obsudze
+ Efektywny
+ Bezpieczny
+ Weryfikowalny
+ Wolny jak w wolnoci[fn:freedom]
[fn:freedom] (en. /Free as in freedom/ - Richard Matthew Stallman) - dotyczy wolnociowego podejcia do oprogramowania

* Spos贸b dziaania
** Rsync + tar

W najprostszej konfiguracji backup mo偶emy wykona dokonujc kompresji danych (z pomoc /tar/), a nastpnie wysyajc je w dowolne miejsce z /rsync/. Przykadowa konfiguracja znajduje si poni偶ej:

#+NAME:
#+BEGIN_SRC shell
tar cazf /tmp/backup.tar.gz /media && rsync /tmp/backup.tar.gz /mnt/$(date +%s).tar.gz
#+END_SRC

Uruchomienie powy偶szego skryptu utworzy tymczasowy plik ~backup.tar.gz~, kt贸ry zostanie umieszczony w katalogo ~/mnt~. Plik tymczasowy zostanie usunity po ponownym uruchomieniu komputera, jednak w przypadku uruchamiania go na serwerach w celu oszczdzania miejsca.

Aby odzyska dane wykonujemy podobne polecenia, lecz w odwrotnej kolejnoci.

** Duplicati

Dziaajcy w tle serwis Duplicai sprawdza czy warunki uruchomienia danej konfiguracji zostay spenione. Je偶eli tak, uruchamiany jest proces wykonujcy kopi. W przypadku wystpienia bdu otrzymujemy powiadomienie o niepowodzeniu. Informacja o tym, kiedy wykonana zostaa odstatnia kopia zapasowa dostpna jest z poziomu interfejsu przegldarkowego. Jest on dostpny z hosta na porcie 8200.

Format w jakim Duplicati tworzy backupy oparty jest na blokach. Oznacza to, 偶e Duplicati nie kopiuje bezporednio plik贸w w wybrane miejsce, a dzieli i czy je w mniejsze bloki staej dugoci. Nazwy stworzonych blok贸w s tworzone tak, aby nie niosy za sob informacji o dacie stworzenia ani zawartoci, dziki czemu mo偶na je bezpiecznie przechowywa w chmurze. Informacja o tym, jakie pliki znajduj si w danym bloku znajduje si w bazie danych, kt贸ra zostaje stworzona dla ka偶dej z kopii zapasowych (zar贸wno lokalnie, jak i zdalnie).

#+NAME: Fragment pliku filenames.json zawierajcego informacje o przechowywanych plikach
#+BEGIN_SRC json
[
  {
  "type": "Folder",
  "path": "C:\\data\\"
  },
  {
  "type": "File",
  "path": "C:\\data\\mydoc.txt",
  "size": 4096,
  "hash": "qaFXpxVTuYCuibb9P41VSeVn4pIaK8o3jUpJKqI4VF4="
  },
  {
  "type": "File",
  "path": "C:\\data\\myvideo.mp4",
  "size": 215040,
  "hash": "4sGwVN/QuWHD+yVI10qgYa4e2F5M4zXLKBQaf1rtTCs=",
  "blocklists": [ "Uo1f4rVjNRX10HkxQxXauCrRv0wJOvStqt9gaUT0uPA=" ]
  }
]
#+END_SRC

Skd Duplicati wie, 偶e plik zosta zmieniony? Oblicza jego /hash/ i umieszcza go w nowym pliku filelist.json w celu p贸藕niejszego por贸wnania podczas tworzenia kolejnej kopii. Duplicati tworzc blok danych /dblock/ dodatkowo dodaje informacje o przechowanych w nich /hash/ w bazie /dindex/. [fn:: https://www.duplicati.com/articles/Backup-Process/] Plik filelist.json tworzony jest dla ka偶dej stworzonej kopii, pozwala to na szybkie odtworznie dowolnego stanu plik贸w, poniewa偶 plik ten zawiera informacje, w kt贸rych blokach szuka danych wersji pliku.

Aby zapewni dodatkowe bezpieczestwo Duplicati sugeruje, aby szyfrowa
wszystkie dane. Aplikacja automatycznie generuje haso i je zapisuje, a my tak
wygenerowan konfiguracj (z zapisanymi hasami) mo偶emy zapisa w bezpiecznym
miejscu (np. Secure Notes w Bitwarden). Szyfrowanie blok贸w daje nam pewno, 偶e
nawet dostawca usug chmurowych nie bdzie w stanie podejrze jakie dane
przechowyujemy na jego serwerze.

#+CAPTION: Schemat blokowy procesu tworzenia kopii przez Duplicati
[[./img/duplicati/duplicati-processing-files-and-folders.png]]

** Restic
Restic dziaa na zasadzie kopii przyrostowych - dziki temu jest zdolny do tworzenia stosunkowo maych kopii nawet przy du偶ych ilociach danych. Pozwala tak偶e na atwe przywr贸cenie kopii przez interfejs terminala. Jego dziaanie jest analogiczne do podmontowania np. pendrive.

Kopie zapasowe prowadzone przez Restica mo偶na bardzo prosto zaszyfrowa, jak i wysya na r贸偶ne rodzaje pamici sieciowych - od S3, przez SSHFS i WebDav a偶 po rozwizania typowo konsumenckie jak Google Drive, Mega czy OneDrive. W przypadku czci integracji wymagane jest u偶ycie Rclone, kt贸ry jest interfejsem do poczenia si z dan chmur. Bez najmniejszego problemu jest tak偶e dostpny backup lokalny, kt贸ry tworzony jest w niemal identyczny spos贸b jak ten chmurowy.

Ka偶da kopia zapasowa ma swoje repozytorium - miejsce, gdzie pliki odpowiadajce za kopi s trzymane. Jest to miejsce, kt贸rego nie chcemy straci (ale i tak prawdopowodobnie mamy inny backup, jeli trzymamy si zasad ).
* Retencja
** Rsync + tar

Poniewa偶 rsync wycznie wysya pliki do danej lokalizacji, to u偶ytkownik jest odpowiedzialny za zarzdzaniem plikami na zdalnym serwerze. Najprostszym sposobem na zarzdzaniem nimi jest umieszczenie skryptu, kt贸ry bdzie realizowa dwoln polityk retencji. Przykadowy skrypt zosta opisany poni偶ej.

#+NAME: Przykad retencji - usuwa kopie starsze ni偶 30 dni
#+BEGIN_SRC shell
find /mnt -name '*tar.gz' -mtime +30 -delete -print
#+END_SRC

Skrpt ten wyszukuje wszystkie pliki z rozszerzeniem ~.tar.gz~ i spor贸d nich uwuwa te, utworzone wczeniej ni偶 30 dni temu.

** Duplicati

Duplicati oferuje zar贸wno gotowe tryby retencji, jak i pozwala na dostosowanie jej. Mo偶emy wybiera spor贸d nastpujcych tryb贸w:

- /Keep all backups/ - 偶adne dane nie zostaj usunite (utrzymywane s wszystkie wersje plik贸w). Kopia zapasowa bdzie rosa z ka偶d zmian.
- /Delete backups that are older than/ - usuwa wszystkie kopie plik贸w starsze ni偶 podany czas, o ile znaleziona zostanie co najmniej jedna nowsza wersja danej kopii.
- /Keep a specific number of backups/ - najstarsze kopie ponad podan ilo s usuwane.
- /Smart backup retention/ - tryb smart, kopie zostaj usuwane automatycznie je偶eli bdzie ich wicej ni偶:
    - Po jednej kopii na ka偶dy z ostatnich 7 dni
    - Po jednej kopii na ka偶dy z ostatnich 4 togodnii
    - Po jednej kopii na ka偶dy z ostatnich 12 miesicy
    - Przy czym zawsze istnie bdzie co najmniej jedna kopia danych
- /Custom backup retention/ - pozwala na ustawienie dowolnej kombinacji w formacie: =NUMER= =CZAS=:=NUMER= =CZAS=. Np. 1W:1D, pozostawia na nastpne 7 dni jedn kopi z ka偶dego dnia.

** Restic
Retencj w Resticu mo偶na bardzo atwo skonfigurowa. Standardowo parametry do niej s podawane podczas wywoania komendy. Tymi argumentami s:
+ =--keep-daily n=
+ =--keep-weekly n=
+ =--keep-monthly n=
+ =--keep-yearly n=
Opisuj ile kopii z danego okresu mamy minimalnie trzyma. Dla np. =--keep-daily 3= bdziemy zawsze mieli ostatnie 3 kopie z danego dnia. Jeli np. w rod zrobimy cztery kopie numerowane chronologicznie od najstarszych - $A$, $B$, $C$ i $D$ - przy takim ustawieniu bdziemy mieli dostp tylko do kopii $B$, $C$ i $D$. Analogicznie dziaa to dla pozostaych argument贸w, kt贸re mo偶emy doda przy wywoaniu funkcji.
* Typy kopii
** Rsync + tar

Rsync + tar pozwala wycznie na jeden typ kopii - pene. Z ka偶dym uruchomieniem backupu stworzona zostanie pena kopia danych. Najwiksz wad takiego rozwizania jest to, 偶e bdzie on r贸s z ka偶d kopi (nawet je偶eli nie dokonalimy 偶adnych zmian), co mo偶e doprowadzi do wyczerpania przestrzeni dyskowej znacznie szybciej od innych opcji. Zdecydowan zalet jest prostota i atwo przywr贸cenia kopii - wystarczy przenie i rozpakowa kopi.

** Duplicati
** Restic
Jedyn opcj w tym wypadku jest kopia pena podczas inicjalizacji repozytorium, a nastpnie kopie przyrostowe. Pozwala to na ,,cofnicie si w czasie'' o niemal dowolne okno, poniewa偶 mao prawdopodobne jest, 偶e za rok bdziemy potrzebowali kopii z dokadnoci co do dnia.
* Chmura
** Rsync + tar

Rsync nie wspiera umieszczania plik贸w na chmurze, poniewa偶 wykorzystuje ssh do kopiowania plik贸w do zdalnych katalog贸w (czego chmury nie wspieraj). Istnieje jednak alternatywa, wanie dla rozwiza chmurowych - RClone [fn:: https://github.com/rclone/rclone]. Pozwala on na synchronizacj danych z chmur, a tak偶e zamontowanie chmury jako katalogu. Uruchamiajc =rclone config= zostaniemy przeprowadzeni przez proces konfiguracji nowej chmury, kt贸r p贸藕niej mo偶emy wykorzysta do stworzenia kopii. Poni偶ej znajduje si przykad z dokumentacji:

#+CAPTION: Konfiguracja Backblaze B2 w rclone
#+BEGIN_SRC text
rclone config

No remotes found - make a new one
n) New remote
q) Quit config
n/q> n
name> remote
Type of storage to configure.
Choose a number from below, or type in your own value
[snip]
XX / Backblaze B2
   \ "b2"
[snip]
Storage> b2
Account ID or Application Key ID
account> 123456789abc
Application Key
key> 0123456789abcdef0123456789abcdef0123456789
Endpoint for the service - leave blank normally.
endpoint>
Remote config
--------------------
[remote]
account = 123456789abc
key = 0123456789abcdef0123456789abcdef0123456789
endpoint =
--------------------
y) Yes this is OK
e) Edit this remote
d) Delete this remote
y/e/d> y
#+END_SRC

** Duplicati

Duplicati zostao zbudowane z myl o tworzeniu zadalnych kopii. Wspiera standardowe protokoy FTP, SSH i WebDAV. Ponadto dobrze integruje si z serwisami oferujcymi przestrze dyskow typu Microfost OneDrive, Google Drive, Mega itp. oraz wspiera serwisy chmurowe: Backblaze B2, Google Cloud Storage, Amazon S3. [fn:: https://www.duplicati.com/] Przykady integracji z chmur znajduj si poni偶ej.
*** Backblaze B2

Integracja z Backblaze B2 jest bardzo prosta, sprowadza si do ustawienia B2 jako miejsca, gdzie bdziemy dane przechowywa, stworzeniu bucketa i wprowadzeniu kluczy dostpu do niego. Proces tworzenia klucza i konfiguracji Duplicati zosta umieszczony poni偶ej.

#+CAPTION: Tworzenie bucketa w Backblaze B2
[[./img/duplicati/backblaze/6.png]]

Po utworzeniu bucketa, nale偶y stworzy klucz aplikacji, kt贸ry pozwoli Duplicati na dostp do chmury.

#+CAPTION: Tworzenie klucza dostpu
[[./img/duplicati/backblaze/7.png]]

Wygenerowany klucz nale偶y natychmiast wprowadzi do aplikacji, gdy偶 nie mo偶na go odczyta drugi raz - nale偶aoby stworzy nowy klucz dostpu.

#+CAPTION: Wygenerowany klucz
[[./img/duplicati/backblaze/8.png]]

Tak wygenerowny klucz wprowadzamy do aplikacji.

*** Google Cloud Storage

W przypadku Google Cloud Storage wymagania s podobne. Jednak, poniewa偶 interfejs Google Cloud jest znacznie bardziej rozbudowany, Duplicati oferuje automatyczne wygenerowanie kluczy dostpu korzystajc z OAuth, pozostaa cz konfiguracji przebiega identycznie jak w przypadku Backblaze B2. Zacz nale偶y tak jak poprzednio, od utworzenia bucketa w Google Cloud Storage.

#+CAPTION: Stworzenie bucketa w Google Cloud Storage
[[./img/duplicati/google/1.png]]

Nastpnie nale偶y wej w link [[https://duplicati-oauth-handler.appspot.com?type=gcs]]. Wtedy po naciniciu przycisku (rysunek poni偶ej), nale偶y si zalogowa do konta Google.

#+CAPTION: Autoryzacja w GCS
[[./img/duplicati/google/3.png]]

Po autozyzacji uzyskany AuthId wpisujemy jak na obrazku poni偶ej.

#+CAPTION: Konfiguracja GCS w Duplicati
[[./img/duplicati/google/4.png]]

** Restic
Restic ma bardzo rozbudowan integracj z chmur - zar贸wno bezporedni, jak i z pomoc narzdzi takich jak rclone. Najprociej integruje si z /object storage/[fn:object_storage]. S to chmury nakierowane na trzymanie wielu maych plik贸w.
[fn:object_storage] - przestrze obiektowa, pozwala na proste trzymanie wielu maych plik贸w i jest wanie w tym celu zoptymalizowane. ,,Klasyczne'' chmury, kt贸re bezporednio udostpniaj dysk nazywane s /block storage/.

Autorzy chwal si natywnym wsparciem dla kilkunastu r贸偶nych chmur, kt贸re mo偶na podzieli na trzy r贸偶ne kategorie:
1. Backup lokalny - dziaa na dysku podczonym do komputera
2. Backup do block storage - Autorzy dostarczaj obsug protokou SFTP (/SSH File Transfer Protocol/), a tak偶e wasny serwer obsugujcy HTTP(S).
3. Backup do object storage - wspierane jest wiele najbardziej popularnych chmur takich jak AWS S3, Backblaze B2, Azure Blob Storage, Wasabi, a tak偶e opcje selfhosted w postaci Minio i OpenStack Swift.

Dodatkowe opcje dostarcza Rclone, kt贸ry pozwala zamontowa nam ponad 50 r贸偶nych chmur, a co za tym idzie istotnie rozszerzy funkcjonalno naszego rozwizania. Dziki cisej integracji nie ma potrzeby podmontowywania danej chmury pod folder, co dziaa na nasz korzy ze wzgldu na jeszcze lepsze zabezpieczenie przed Ransomware.
